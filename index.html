<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ThePoggerSquad Shop — Product Portal</title>
<meta name="theme-color" content="#070914"/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Exo+2:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#070914;
    --ink:#f4f7ff; --muted:#9aa7c7;
    --a:#ff2bd1; --b:#08f7fe; --c:#f5d300; --d:#00ff85;
    --panel:rgba(10,17,40,.82); --line:rgba(255,255,255,.12);
    --btn-ink:#061018;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font:16px/1.6 "Exo 2", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:var(--bg);
    overflow-x:hidden; overflow-y:auto;
    text-rendering:optimizeLegibility;
  }

  /* ===== Endless synthwave grid ===== */
/* --- Synthwave palette presets (edit these) --- */
:root{
  --pal1a:#ff2bd1; --pal1b:#08f7fe;  /* magenta → cyan */
  --pal2a:#f5d300; --pal2b:#ff2bd1;  /* gold → magenta */
  --pal3a:#7a5cff; --pal3b:#00ff85;  /* violet → neon green */

  /* working vars the animation will swap */
  --bgA:var(--pal1a);
  --bgB:var(--pal1b);
}

/* ===== Brighter synthwave background ===== */
.bg{
  position:fixed; inset:0; z-index:-2; overflow:hidden;
  /* crossfade between palettes */
  animation:paletteShift 24s ease-in-out infinite;
}

/* Deep glow + gradient wash (brighter than before) */
.bg::before,
.bg::after{
  content:""; position:absolute; inset:-180% -180%;
}
.bg::before{
  /* main color wash using animated vars */
  background:
    radial-gradient(90rem 44rem at 50% -8%, color-mix(in oklab, var(--bgA) 40%, transparent) 0 55%, transparent 60%),
    radial-gradient(70rem 36rem at 50% 112%, color-mix(in oklab, var(--bgB) 36%, transparent) 0 60%, transparent 66%),
    linear-gradient(#0b1024, #0b0f21);
  filter: brightness(2.0) saturate(1.8);
}
.bg::after{
  /* soft vignette + extra glow */
  background:
    radial-gradient(160rem 90rem at 50% 50%, rgba(255,255,255,.08), transparent 70%),
    radial-gradient(80rem 40rem at 20% 15%, rgba(255,255,255,.06), transparent 60%),
    radial-gradient(80rem 40rem at 80% 85%, rgba(255,255,255,.06), transparent 60%);
  mix-blend-mode: screen;
  opacity:.9;
}

/* Neon grid overlay (brighter lines) */
.bggrid{
  position:fixed; inset:0; z-index:-1;
  background:
    repeating-linear-gradient(0deg, rgba(160,190,255,.26) 0 1px, transparent 1px 52px),
    repeating-linear-gradient(90deg, rgba(160,190,255,.26) 0 1px, transparent 1px 88px);
  -webkit-mask: radial-gradient(circle at 50% 35%, black 0 42%, transparent 72%);
          mask: radial-gradient(circle at 50% 35%, black 0 42%, transparent 72%);
  filter: drop-shadow(0 0 14px rgba(122,160,255,.55));
  animation:scrollgrid 22s linear infinite;
}

@keyframes scrollgrid{
  0%{background-position:0 0,0 0}
  100%{background-position:0 260px,220px 0}
}

/* Swap between 3 palettes only (no full RGB rainbow) */
@keyframes paletteShift{
  0%, 24%   { --bgA:var(--pal1a); --bgB:var(--pal1b); }
  25%, 49%  { --bgA:var(--pal2a); --bgB:var(--pal2b); }
  50%, 74%  { --bgA:var(--pal3a); --bgB:var(--pal3b); }
  75%, 100% { --bgA:var(--pal1a); --bgB:var(--pal1b); }
}

  /* ===== Frame ===== */
  .wrap{position:relative; width:min(1040px,92vw); margin:0 auto; min-height:100%; display:grid; place-items:center}
  .shell{
    width:100%; max-width:1040px; margin:12px auto;
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.14);
    border-radius:22px; box-shadow:0 30px 120px rgba(0,0,0,.6);
    overflow:hidden; transform:translateY(12px) scale(.98); opacity:0; animation:drop .7s cubic-bezier(.2,.8,.2,1) .1s forwards;
    backdrop-filter: blur(10px);
  }
  @keyframes drop{to{transform:translateY(0) scale(1); opacity:1}}

  header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:12px 14px; border-bottom:1px solid var(--line);
    background: linear-gradient(90deg, rgba(255,43,209,.14), rgba(8,247,254,.10));
  }
  .brand h1{
    margin:0; font-family:"Orbitron", system-ui; font-weight:800; font-size:18px; letter-spacing:.6px; text-transform:uppercase;
  }
  .nav{display:flex; gap:8px}
  .nav a{
    color:#dbe5ff; text-decoration:none; font-weight:800; letter-spacing:.35px;
    padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
  }
  .nav a.active{border-color:#8bb3ff; color:#8bb3ff}
  .subGuide{display:none;}
  @media (min-width:780px){
    .subGuide{
      display:block; font-size:13px; color:#cfe0ff; opacity:.95;
      padding:6px 10px; border-radius:10px;
      background:linear-gradient(180deg, rgba(8,247,254,.10), rgba(255,43,209,.06));
      border:1px solid rgba(255,255,255,.12);
      max-width:60ch;
    }
  }

  main{display:grid; grid-template-columns:1fr}
  section{display:none; padding:14px}
  section.show{display:block; animation:fade .35s ease}
  @keyframes fade{from{opacity:.25; transform:translateY(6px)} to{opacity:1; transform:none}}
  .center{display:grid; place-items:center; padding:28px 14px; gap:12px}

  .entry{
    display:flex; gap:10px; align-items:center; padding:14px; background:var(--panel);
    border-radius:16px; border:1px solid var(--line);
    box-shadow: 0 10px 28px rgba(10,14,40,.6), inset 0 0 0 1px rgba(255,255,255,.02);
    backdrop-filter: blur(12px);
  }
  @media (max-width:560px){
    .entry{flex-wrap:wrap}
    #codeInput{flex:1 1 100%; min-width:0}
    #btnOpen{width:100%}
  }
  .entry--wide{width:100%; max-width:760px}

  input[type="text"], input[type="number"], select{
    width:100%; background:#0b1431; color:var(--ink); border:1px solid rgba(255,255,255,.2);
    padding:14px 16px; border-radius:12px; outline:none; transition:border .2s ease, box-shadow .2s ease;
    font-weight:700; letter-spacing:.4px;
  }
  input:focus, select:focus{border-color:#8bb3ff; box-shadow:0 0 0 8px rgba(139,179,255,.12)}

  /* ===== Buttons ===== */
  .btn{
    --g1: var(--b); --g2: var(--a);
    background:linear-gradient(180deg, var(--g1), var(--g2));
    color:var(--btn-ink); border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:900;
    letter-spacing:.4px; text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    box-shadow:0 14px 34px rgba(8,247,254,.22), 0 0 0 1px rgba(255,255,255,.08) inset;
    transition:transform .07s ease, filter .2s ease, box-shadow .2s ease;
  }
  .btn:hover{ filter:brightness(1.07); box-shadow:0 16px 40px rgba(8,247,254,.32), 0 0 0 1px rgba(255,255,255,.12) inset }
  .btn:active{ transform:translateY(1px) }
  .btn.ghost{
    background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.02));
    color:#dbe5ff; border:1px solid rgba(255,255,255,.2);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
  }
  .btn.small{ padding:10px 12px; font-weight:800 }
  .btnRow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

  .muted{color:var(--muted); font-size:14px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .grid{display:grid; gap:12px} /* generic helper (safe now) */

  /* ===== Product layout ===== */
  .product{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 10px 28px rgba(10,14,40,.6), inset 0 0 0 1px rgba(255,255,255,.02)}
  .product-header{
    display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; margin-bottom:10px
  }
  .product-title{margin:0; font-family:Orbitron; letter-spacing:.4px}
/* Big neon unit badge */
.unitBadge{
  position:relative;
  display:inline-block;
  margin-top:8px;
  font-family:Orbitron, system-ui;
  font-weight:900;
  font-size:18px;            /* bigger text */
  letter-spacing:.8px;
  padding:10px 16px;         /* bigger pill */
  border-radius:999px;
  color:#eaf2ff;

  /* inner surface */
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.28);
  box-shadow:
    0 0 0 1px rgba(255,255,255,.04) inset,
    0 8px 28px rgba(8,247,254,.22),
    0 0 22px rgba(255,43,209,.18);

  /* gentle pulsing */
  animation:glowPulse 3.6s ease-in-out infinite;
}

/* moving sheen highlight */
.unitBadge::after{
  content:"";
  position:absolute; inset:0;
  border-radius:inherit;
  background:linear-gradient(115deg, transparent 0%, rgba(255,255,255,.45) 10%, transparent 20%);
  filter: blur(1px);
  transform: translateX(-130%);
  animation: sheen 4.5s ease-in-out infinite;
  pointer-events:none;
}

@keyframes glowPulse{
  0%,100%{ box-shadow:
    0 0 0 1px rgba(255,255,255,.04) inset,
    0 8px 28px rgba(8,247,254,.18),
    0 0 18px rgba(255,43,209,.14); }
  50%{ box-shadow:
    0 0 0 1px rgba(255,255,255,.06) inset,
    0 10px 34px rgba(8,247,254,.30),
    0 0 28px rgba(255,43,209,.24); }
}

@keyframes sheen{
  0%   { transform: translateX(-130%); opacity:.0 }
  12%  { transform: translateX(130%);  opacity:.6 }
  100% { transform: translateX(130%);  opacity:0 }
}


  .product-body{display:grid; grid-template-columns:1.2fr .8fr; gap:18px; min-width:0}
  .product-main{min-width:0}
  .product-aside{min-width:0}
  @media (max-width:960px){ .product-body{grid-template-columns:1fr} }

  .section{margin-top:14px; padding-top:12px; border-top:1px solid var(--line)}
  .section h3{margin:0 0 6px; font-family:Orbitron; letter-spacing:.3px}

  /* Gallery */
  .gallery{display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:10px}
  .thumb{position:relative; border-radius:12px; overflow:hidden; background:#0b1431; border:1px solid rgba(255,255,255,.12); cursor:pointer}
  .thumb img{width:100%; height:auto; display:block; aspect-ratio:4/3; object-fit:cover}
  .thumb .badge{position:absolute; bottom:6px; right:6px; font-size:11px; background:rgba(0,0,0,.45); padding:2px 6px; border-radius:999px}
  .thumb .play{position:absolute; inset:0; display:grid; place-items:center; background: radial-gradient(circle at 50% 50%, rgba(0,0,0,.0), rgba(0,0,0,.25))}
  .thumb .play svg{width:34px;height:34px; filter: drop-shadow(0 2px 8px rgba(0,0,0,.5))}

  /* Features animated text */
  .features{display:grid; gap:6px}
  .feature-anim{
    font-weight:800;
    background:linear-gradient(90deg, var(--a), var(--b), var(--c), var(--d), var(--a));
    background-size:300% 100%; -webkit-background-clip:text; background-clip:text; color:transparent;
    animation:shimmer 6s linear infinite; letter-spacing:.25px;
  }
  @keyframes shimmer{ 0%{background-position:0% 50%} 100%{background-position:100% 50%} }

  /* Sidebar cards */
  .asideCard{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.015)); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow: 0 6px 20px rgba(10,14,40,.5), inset 0 0 0 1px rgba(255,255,255,.02)}
  .asideCard > strong{font-family:Orbitron}
  .divider{height:1px; background:linear-gradient(90deg,transparent, rgba(255,255,255,.18), transparent); margin:10px 0}
  .tags{display:flex; flex-wrap:wrap; gap:8px}
  .tag{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02)); color:#dfe7ff; letter-spacing:.3px; transition: box-shadow .2s ease, transform .05s ease}
  .tag:hover{ box-shadow:0 0 12px rgba(122,160,255,.35); transform:translateY(-1px) }
  .resList{display:flex; flex-direction:column; gap:8px}
  .resList a{text-decoration:none}

  /* Lightbox */
  .lightbox{position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:99; padding:16px}
  .lightbox.show{display:flex; animation:fade .2s ease}
  .lightbox .box{max-width:min(960px,92vw); width:100%; background:rgba(10,17,40,.92); border:1px solid rgba(255,255,255,.2); border-radius:16px; overflow:hidden; box-shadow:0 30px 90px rgba(0,0,0,.6)}
  .lightbox .mediaWrap{display:grid; place-items:center; background:#0b1431}
  .lightbox img{max-width:100%; height:auto; display:block}
  .lightbox video{width:100%; height:auto; display:block; background:#000}
  .lightbox .top{display:flex; align-items:center; justify-content:space-between; padding:10px 12px}
  .x{background:transparent; border:1px solid rgba(255,255,255,.25); color:#fff; padding:6px 10px; border-radius:10px; cursor:pointer}

  /* ===== About page ===== */
  .aboutWrap{display:grid; gap:16px}
  .aboutHero{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius:16px; padding:18px}
  .aboutHero h2{margin:0 0 6px; font-family:Orbitron; letter-spacing:.4px}
  .aboutGrid{display:grid; gap:14px; grid-template-columns:repeat(3,1fr)}
  .aboutCard{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 6px 20px rgba(10,14,40,.5), inset 0 0 0 1px rgba(255,255,255,.02)}
  .aboutCard h3{margin:0 0 8px; font-family:Orbitron; letter-spacing:.3px}
  .aboutList{margin:0; padding-left:18px}
  .aboutFoot{display:flex; gap:10px; flex-wrap:wrap}
  @media (max-width:960px){ .aboutGrid{grid-template-columns:1fr} }

  .visually-hidden{position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; border:0; padding:0; margin:-1px;}
</style>
</head>
<body>
<div class="bg"></div><div class="bggrid"></div>

<div class="wrap">
  <div class="shell">
    <header>
      <div class="brand"><h1>The Pogger Squad Shop</h1></div>
      <div class="subGuide">This page is where you can input your unique product code. The code can be found on the product page included in the package. Enter your code to unlock your unique unit number, media, perks, resources, and support!</div>
      <nav class="nav">
        <a href="#" id="navHome" class="active">Home</a>
        <a href="#" id="navAbout">About</a>
      </nav>
    </header>

    <main>
      <!-- HOME -->
      <section id="lookup" class="show" aria-labelledby="lookupTitle">
        <div class="center">
          <h2 id="lookupTitle" class="visually-hidden">Enter Product Code</h2>
          <div class="entry entry--wide">
            <input id="codeInput" type="text" placeholder="Type Your Code Here" autocomplete="off" inputmode="latin-prose" aria-label="Product code"/>
            <button class="btn" id="btnOpen" aria-label="Open product">Open</button>
          </div>
        </div>
        <div id="result" style="padding:0 8px 18px"></div>
      </section>

      <!-- ADMIN -->
      <section id="admin" aria-labelledby="adminTitle">
        <div class="row" style="margin-bottom:10px">
          <a href="#" class="btn ghost small" id="adminBack" aria-label="Back to Home">← Home</a>
        </div>
        <h2 id="adminTitle" class="visually-hidden">Admin</h2>
        <div class="entry" style="margin-bottom:12px">
          <div style="width:100%">
            <div class="row" style="justify-content:space-between">
              <strong style="font-family:Orbitron">Generate Codes</strong>
              <span class="muted">Select product & unit number</span>
            </div>
            <div class="divider"></div>
            <div class="row" style="gap:12px">
              <label style="flex:1">Product
                <select id="productSelect"></select>
              </label>
              <label style="width:200px">Unit #
                <input id="unitNumber" type="number" min="0" step="1" value="0"/>
              </label>
              <button class="btn" id="btnGen">Generate</button>
            </div>
          </div>
        </div>
        <div class="entry">
          <div style="width:100%">
            <strong style="font-family:Orbitron">Codes</strong>
            <div class="divider"></div>
            <div id="codesOut" style="background:#0b1431; border:1px dashed rgba(255,255,255,.25); border-radius:12px; padding:12px; font:13px/1.6 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#d7e7ff; white-space:pre-wrap"></div>
          </div>
        </div>
      </section>

      <!-- ABOUT -->
      <section id="about" aria-labelledby="aboutTitle">
        <div class="aboutWrap">
          <div class="aboutHero">
            <h2 id="aboutTitle">About ThePoggerSquad Shop On Etsy</h2>
            <p style="margin:0">Tech, Games, & Retro. We custom design and produce quality products with one thing in mind: Coolness.</p>
          </div>

          <div class="aboutGrid">
            <div class="aboutCard">
              <h3>What is this web portal for?</h3>
              <ul class="aboutList">
                <li>Shows verified product info & media for your exact unit.</li>
                <li>Gives you quick how-to and care tips.</li>
                <li>Links you to perks, downloads, and support.</li>
              </ul>
            </div>
            <div class="aboutCard">
              <h3>Where to find your code:</h3>
              <ul class="aboutList">
                <li>Look for it on the product info sheet</li>
                <li>Format looks like <code>Q7A-5K2-JD</code>.</li>
                <li>Enter it on the Home screen to unlock your product page.</li>
              </ul>
            </div>
            <div class="aboutCard">
              <h3>Visit our Etsy shop:</h3>
              <p>Browse current drops, new gear, awesome loot, and more cool stuff:</p>
              <p><a href="https://www.etsy.com/shop/ThePoggerSquad" class="btn small" target="_blank" rel="noopener">Visit on Etsy</a></p>
            </div>
          </div>

          <div class="aboutGrid">
            <div class="aboutCard">
              <h3>Support</h3>
              <p>Need help? Use the <em>Request Support</em> button on your product page or open our storefront, where you can contact us on Etsy:</p>
              <p><a id="aboutSupport" href="#" class="btn ghost small" target="_blank" rel="noopener">Open Support</a></p>
            </div>
            <div class="aboutCard">
              <h3>Portal Feedback</h3>
              <p>Have ideas for this portal or found a bug? Contact us on Etsy here:</p>
              <p><a id="feedbackLink" href="#" class="btn small" target="_blank" rel="noopener">Leave Portal Feedback</a></p>
            </div>
            <div class="aboutCard">
              <h3>Privacy</h3>
              <p>No account required. Codes only reveal product details and unit metadata—no personal info is stored.</p>
            </div>
          </div>

          <div class="aboutFoot">
            <a href="#" id="aboutBack" class="btn ghost small">Back to Home</a>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" aria-modal="true" role="dialog">
  <div class="box">
    <div class="top"><div id="lbTitle"></div><button class="x" id="lbClose" aria-label="Close">Close</button></div>
    <div class="mediaWrap" id="lbMedia"></div>
  </div>
</div>

<script>
/* =========================
   GLOBAL CONFIG
   ========================= */
const SECRET = "CHANGE_ME_SECRET_SALT";
const ADMIN_TRIGGER_CODE = "RL098ight";

let SUPPORT_URL_GLOBAL = "https://www.etsy.com/shop/ThePoggerSquad"; // optional global fallback if a product has no supportUrl
let REVIEW_URL_GLOBAL = "https://www.etsy.com/shop/ThePoggerSquad#reviews";  // optional global fallback
let FEEDBACK_URL = "https://www.etsy.com/shop/ThePoggerSquad";       // About page feedback
let ABOUT_SUPPORT_URL = "https://www.etsy.com/shop/ThePoggerSquad";  // About page "Open Support" link

/* =========================
   CODEC (Crockford base32 + obfuscation)
   ========================= */
const ALPHABET = "0123456789ABCDEFGHJKMNPQRSTVWXYZ";
const base = ALPHABET.length;
const toB32 = (n, width=1)=>{ let s=""; do{ s=ALPHABET[n%base]+s; n=Math.floor(n/base);}while(n>0); while(s.length<width) s="0"+s; return s; };
const fromB32 = (s)=>{ let n=0; for(const ch of s){ const i=ALPHABET.indexOf(ch); if(i<0) return NaN; n=n*base+i; } return n; };
const randBlock = (len)=> Array.from({length:len},()=> ALPHABET[Math.floor(Math.random()*base)]).join("");
function crc16(str){ let c=0xFFFF; for(let i=0;i<str.length;i++){ c^=str.charCodeAt(i); for(let k=0;k<8;k++){ c = (c & 1) ? (c>>>1) ^ 0xA001 : (c>>>1); } } return c & 0xFFFF; }
function crc10(str){ return crc16(str) & 0x3FF; }
function productTagIndex(productId){ return crc16(productId + "|" + SECRET) & 31; }

/* Code: AAA-BBBB-CC */
function buildCode(productId, unit){
  if(unit<0) unit=0; if(unit>32767) unit = unit % 32768;
  const AAA = randBlock(3);
  const tag = productTagIndex(productId) & 31;
  const payload = (tag << 15) | (unit & 0x7FFF);
  const mask = crc16(AAA + SECRET) & 0xFFFF;
  const obf = payload ^ (mask & 0xFFFFF);
  const BBBB = toB32(obf, 4);
  const CC = toB32(crc10(AAA + BBBB + SECRET), 2);
  return `${AAA}-${BBBB}-${CC}`;
}
function decodeCode(c){
  const s = (c||"").trim().toUpperCase();
  if(!/^[0-9A-HJKMNPQRSTVWXYZ]{3}-[0-9A-HJKMNPQRSTVWXYZ]{4}-[0-9A-HJKMNPQRSTVWXYZ]{2}$/.test(s))
    return {ok:false, reason:"format"};
  const [AAA, BBBB, CC] = s.split("-");
  const chk = toB32(crc10(AAA + BBBB + SECRET), 2);
  if(chk !== CC) return {ok:false, reason:"checksum"};
  const obf = fromB32(BBBB);
  const mask = crc16(AAA + SECRET) & 0xFFFF;
  const payload = obf ^ (mask & 0xFFFFF);
  const tag = (payload >> 15) & 31;
  const unit = payload & 0x7FFF;
  return {ok:true, tag, unit, code:s};
}

/* =========================
   DATA (products.json)
   ========================= */
let UNIT_PAD = 4;
let PRODUCTS = [];

async function loadProducts(){
  const fail = (msg)=>{ showError("Configuration missing", msg); };
  try{
    const res = await fetch('data/products.json', {cache:'no-store'});
    if(!res.ok) return fail("Create <code>/data/products.json</code> and push to GitHub.");
    const data = await res.json();
    if(Number.isInteger(data.unitPad)) UNIT_PAD = data.unitPad;
    if(data.reviewUrl) REVIEW_URL_GLOBAL = String(data.reviewUrl);
    if(data.supportUrl) SUPPORT_URL_GLOBAL = String(data.supportUrl);
    if(data.feedbackUrl){ FEEDBACK_URL = String(data.feedbackUrl); const a=document.getElementById('feedbackLink'); if(a) a.href = FEEDBACK_URL; }
    if(data.aboutSupportUrl){ ABOUT_SUPPORT_URL = String(data.aboutSupportUrl); const a=document.getElementById('aboutSupport'); if(a) a.href = ABOUT_SUPPORT_URL; }
    PRODUCTS = Array.isArray(data.products) ? data.products : [];
    if(!PRODUCTS.length) return fail("Add at least one product to <code>products.json</code>.");
  }catch(e){
    fail("Couldn’t load <code>products.json</code>. Check path and JSON syntax.");
  }
}

/* =========================
   UI wiring + rendering
   ========================= */
const $ = (q)=>document.querySelector(q);
const show = id => { document.querySelectorAll("main > section").forEach(s=>s.classList.remove("show")); $(id).classList.add("show"); };
const navHome = $("#navHome"), navAbout=$("#navAbout");
function setActive(tab){ [navHome, navAbout].forEach(a=>a.classList.remove("active")); (tab==="home"?navHome:navAbout).classList.add("active"); }

const codeInput=$("#codeInput"), btnOpen=$("#btnOpen"), result=$("#result");
const productSelect=$("#productSelect"), unitNumber=$("#unitNumber"), btnGen=$("#btnGen"), codesOut=$("#codesOut");
const adminBack=$("#adminBack");

navHome.addEventListener("click",(e)=>{ e.preventDefault(); show("#lookup"); setActive("home"); });
navAbout.addEventListener("click",(e)=>{ e.preventDefault(); show("#about"); setActive("about"); });
document.getElementById('aboutBack')?.addEventListener("click",(e)=>{ e.preventDefault(); show("#lookup"); setActive("home"); });
adminBack?.addEventListener("click",(e)=>{ e.preventDefault(); show("#lookup"); setActive("home"); });

btnOpen.addEventListener("click", onOpen);
codeInput.addEventListener("keydown", e=>{ if(e.key==="Enter") onOpen(); });

function onOpen(){
  const raw = codeInput.value.trim();
  if(!raw){ shake(codeInput); return; }
  if(raw === ADMIN_TRIGGER_CODE){ populateAdminProducts(); show("#admin"); setActive("home"); return; }

  const dec = decodeCode(raw);
  if(!dec.ok){ showError("Code not recognized","Please double-check characters"); return; }

  const prod = PRODUCTS.find(p => productTagIndex(p.id) === dec.tag);
  if(!prod){ showError("Unknown product","This code matches no product"); return; }

  renderProduct(prod, dec.unit, dec.code);
  result.scrollIntoView({behavior:"smooth", block:"start"});
}

function showError(title,msg){
  result.innerHTML = `<div class="entry"><div class="row"><div style="font-weight:900; color:#ff708c">${title}</div><div class="muted">${msg}</div></div></div>`;
}

function padUnit(n){ return String(n).padStart(UNIT_PAD, '0'); }

function mdToHtml(md){
  let h = (md||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  h = h.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
  h = h.replace(/\*(.+?)\*/g, "<em>$1</em>");
  h = h.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  h = h.replace(/\n/g,"<br>");
  return h;
}

function renderProduct(prod, unit, code){
  const unitStr = padUnit(unit);
  const reviewUrl = prod.reviewUrl || REVIEW_URL_GLOBAL || "#";
  const supportUrl = prod.supportUrl || SUPPORT_URL_GLOBAL || "#";
  const etsyUrl   = prod.etsyUrl   || "#";

  const feats = (prod.features||[]).map(f=>`<div class="feature-anim">${escapeHtml(f)}</div>`).join("");
  const tags  = (prod.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("");
  const perks = (prod.perks||[]).map(p=>`<a class="btn small" style="--g1:var(--d);--g2:var(--c)" href="${escapeAttr(p.href)}" target="_blank" rel="noopener">${escapeHtml(p.label)}</a>`).join(" ");
  const resources = (prod.resources||[]).map(r=>`<a class="btn ghost small" href="${escapeAttr(r.href)}" target="_blank" rel="noopener">${escapeHtml(r.label)}</a>`).join("");

  const gallery = (prod.media||[]).map((m,i)=>{
    const title = escapeAttr(m.alt || prod.title || "Media");
    if(m.type==="video"){
      const poster = m.poster
        ? `<img src="${escapeAttr(m.poster)}" alt="${title}" loading="lazy">`
        : `<img src="data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'800\' height=\'600\'><rect width=\'100%\' height=\'100%\' fill=\'#0b1431\'/><text x=\'50%\' y=\'52%\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'#9aa7c7\' font-family=\'monospace\' font-size=\'18\'>Video</text></svg>')}" alt="${title}">`;
      return `<div class="thumb" data-idx="${i}" data-kind="video" data-src="${escapeAttr(m.src)}" data-title="${title}">
                ${poster}
                <div class="play" aria-hidden="true"><svg viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg></div>
                <div class="badge">Video</div>
              </div>`;
    }else{
      return `<div class="thumb" data-idx="${i}" data-kind="image" data-src="${escapeAttr(m.src)}" data-title="${title}">
                <img src="${escapeAttr(m.src)}" alt="${title}" loading="lazy">
              </div>`;
    }
  }).join("");

  result.innerHTML = `
  <article class="product">
    <header class="product-header">
      <div style="min-width:220px; flex:1 1 auto">
        <h2 class="product-title">${escapeHtml(prod.title || "Product")}</h2>
        <div class="unitBadge">Unit #${unitStr}</div>
      </div>
      <div class="btnRow">
        <a class="btn small" style="--g1:var(--b);--g2:var(--a)" href="${escapeAttr(etsyUrl)}" target="_blank" rel="noopener">View on Etsy</a>
        <a class="btn ghost small" href="${escapeAttr(supportUrl)}" target="_blank" rel="noopener">Request Support</a>
        <a class="btn ghost small" href="${escapeAttr(reviewUrl)}" target="_blank" rel="noopener">Leave Review</a>
      </div>
    </header>

    <div class="product-body">
      <!-- Main -->
      <div class="product-main">
        ${gallery ? `<div class="gallery" id="gallery">${gallery}</div>` : `<div class="muted">No media yet.</div>`}

        ${prod.descriptionMD ? `<div class="section"><h3>Description</h3><div>${mdToHtml(prod.descriptionMD)}</div></div>` : ""}

        ${(prod.features && prod.features.length) ? `<div class="section"><h3>Features</h3><div class="features">${feats}</div></div>` : ""}

        ${prod.usageMD ? `<div class="section"><h3>How to Use</h3><div>${mdToHtml(prod.usageMD)}</div></div>` : ""}

        ${(prod.perks && prod.perks.length) ? `<div class="section"><h3>Perks</h3><div class="row">${perks}</div></div>` : ""}

        ${prod.hasGame ? `<div class="section"><h3>Mini Game</h3><div class="entry" style="justify-content:center">Coming soon for this item.</div></div>` : ""}
      </div>

      <!-- Sidebar -->
      <aside class="product-aside grid">
        <div class="asideCard">
          <strong>Tags</strong>
          <div class="divider"></div>
          <div class="tags">${tags || `<span class="muted">No tags</span>`}</div>
        </div>

        ${(resources) ? `
        <div class="asideCard">
          <strong>Resources</strong>
          <div class="divider"></div>
          <div class="resList">${resources}</div>
        </div>` : ``}
      </aside>
    </div>
  </article>`;

  wireGallery(prod);
}

/* Lightbox */
const lb = $("#lightbox"), lbMedia=$("#lbMedia"), lbTitle=$("#lbTitle"), lbClose=$("#lbClose");
lbClose.addEventListener("click", ()=> closeLb());
lb.addEventListener("click", (e)=>{ if(e.target===lb) closeLb(); });
function closeLb(){ const vid = lbMedia.querySelector('video'); if(vid){ vid.pause(); } lb.classList.remove("show"); }

function wireGallery(prod){
  const g = $("#gallery"); if(!g) return;
  g.querySelectorAll(".thumb").forEach(th=>{
    th.addEventListener("click", ()=>{
      const kind = th.dataset.kind, src = th.dataset.src, title = th.dataset.title || prod.title || "Media";
      lbTitle.textContent = title;
      lbMedia.innerHTML = (kind==="video")
        ? `<video controls playsinline src="${escapeAttr(src)}"></video>`
        : `<img src="${escapeAttr(src)}" alt="${escapeAttr(title)}">`;
      lb.classList.add("show");
    });
  });
}

/* Admin */
function populateAdminProducts(){
  productSelect.innerHTML = "";
  PRODUCTS.forEach(p=>{
    const o=document.createElement("option");
    o.value = p.id; o.textContent = `#${p.id} — ${p.title}`;
    productSelect.appendChild(o);
  });
}
btnGen?.addEventListener("click", ()=>{
  const pid = parseInt(productSelect.value,10);
  let unit = parseInt(unitNumber.value,10);
  if(Number.isNaN(unit) || unit<0){ alert("Enter a valid unit number (0 or higher)."); return; }
  const code = buildCode(pid, unit);
  codesOut.textContent += (codesOut.textContent ? "\n" : "") + code;
});

/* Helpers */
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function escapeAttr(s){ return (s==null?"":String(s)).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function shake(el){ el.style.transition="transform .08s"; let i=0; const j=setInterval(()=>{ el.style.transform=`translateX(${(i%2?1:-1)*4}px)`; if(++i>8){clearInterval(j); el.style.transform="";}},40); }

/* Boot */
(async function init(){
  await loadProducts();
  if(ABOUT_SUPPORT_URL){ const a=document.getElementById('aboutSupport'); if(a) a.href = ABOUT_SUPPORT_URL; }
  setActive("home");
  setTimeout(()=> document.getElementById('codeInput').focus(), 300);
})();
</script>
</body>
</html>
